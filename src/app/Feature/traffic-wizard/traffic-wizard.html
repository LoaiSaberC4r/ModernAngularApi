<div class="traffic-control-container mt-5">
  <h2 class="main-header">Traffic Wizard</h2>

  <form [formGroup]="trafficForm" class="traffic-form">
    <mat-horizontal-stepper labelPosition="bottom">
      <!-- Step 1: Location and Name -->
      <mat-step [stepControl]="trafficForm">
        <ng-template matStepLabel>Location</ng-template>

        <div class="form-row py-3">
          <div class="form-group">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Governorate</mat-label>
              <mat-select
                formControlName="governorate"
                (selectionChange)="onGovernorateChangeValue($event.value)"
              >
                <mat-option [value]="null">-- Select --</mat-option>
                <mat-option *ngFor="let g of governates" [value]="g.id">{{ g.name }}</mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <div class="form-group">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Area</mat-label>
              <mat-select formControlName="area">
                <mat-option [value]="null">-- Select --</mat-option>
                <mat-option *ngFor="let a of areas" [value]="a.id">
                  {{ a.name }}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </div>
        </div>

        <div class="step-actions">
          <button
            mat-raised-button
            color="primary"
            matStepperNext
            [disabled]="!trafficForm.get('governorate')?.valid || !trafficForm.get('area')?.valid"
          >
            Next
          </button>
        </div>
      </mat-step>

      <!-- Step 2: Coordinates/IP -->
      <mat-step [stepControl]="trafficForm">
        <ng-template matStepLabel>Basic Information</ng-template>

        <div class="form-row py-3">
          <div class="form-group">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>IP Address</mat-label>
              <input matInput formControlName="ipAddress" placeholder="192.168.1.50" />
            </mat-form-field>
          </div>
          <div class="form-group">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Latitude</mat-label>
              <input matInput type="number" formControlName="latitude" step="0.0001" />
            </mat-form-field>
          </div>
          <div class="form-group">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Longitude</mat-label>
              <input matInput type="number" formControlName="longitude" step="0.0001" />
            </mat-form-field>
          </div>
        </div>

        <div class="step-actions">
          <button mat-button matStepperPrevious>Back</button>
          <button
            mat-raised-button
            color="primary"
            matStepperNext
            [disabled]="
              !(
                trafficForm.get('latitude')?.valid &&
                trafficForm.get('longitude')?.valid &&
                trafficForm.get('ipAddress')?.valid
              )
            "
          >
            Next
          </button>
        </div>
      </mat-step>

      <!-- Step 3: Pattern & Timings -->
      <mat-step [stepControl]="trafficForm">
        <ng-template matStepLabel>Configuration</ng-template>

        <mat-card class="light-pattern-section p-3 mb-3">
          <mat-card-header>
            <!-- <mat-card-title class="text-center w-100">LIGHT PATTERN</mat-card-title> -->
          </mat-card-header>
          <mat-card-content>
            <!-- Template Selector -->
            <mat-form-field appearance="outline" class="w-100 mb-3">
              <mat-label>Select Template</mat-label>
              <mat-select formControlName="template" (selectionChange)="onTemplateChange($event)">
                <mat-option [value]="0">-- Select --</mat-option>
                <mat-option *ngFor="let g of templates" [value]="g.id">{{ g.name }}</mat-option>
              </mat-select>
            </mat-form-field>

            <!-- Template Patterns -->
            <div class="template-patterns-section mb-3">
              <h6>Template Patterns</h6>

              <div *ngIf="!templatePatterns?.length" class="text-muted small mb-3">
                No patterns to show. Select a template.
              </div>

              <mat-card
                class="pattern-item mb-2"
                *ngFor="let p of templatePatterns"
                [ngClass]="{ 'selected-pattern': p.lightPatternId === selectedLightPatternId }"
              >
                <mat-card-content class="d-flex align-items-center justify-content-between">
                  <!-- Icon -->
                  <img src="assets/img/traffic-light-305721.png" height="30" alt="Traffic Light" />

                  <!-- Name -->
                  <span class="pattern-name mat-badge px-2 py-1">{{ p.lightPatternName }}</span>

                  <!-- From / To -->
                  <div class="text-center mx-2">
                    <small class="text-muted d-block">From:</small>
                    <span>{{ p.startFrom }}</span>
                  </div>
                  <div class="text-center mx-2">
                    <small class="text-muted d-block">To:</small>
                    <span>{{ p.finishBy }}</span>
                  </div>

                  <!-- Select Button -->
                  <button
                    mat-stroked-button
                    color="{{ p.lightPatternId === selectedLightPatternId ? 'primary' : 'accent' }}"
                    (click)="onTemplatePatternChange(p.lightPatternId)"
                  >
                    {{ p.lightPatternId === selectedLightPatternId ? 'Selected' : 'Select' }}
                  </button>
                </mat-card-content>
              </mat-card>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- <div class="point-configuration">
          <h3 class="section-title">Point Configuration</h3>

          <div class="light-intervals">
            <div class="light-control">
              <img src="assets/img/g.png" height="50" alt="Green" class="light-icon" />
              <label class="light-label">GREEN</label>
              <mat-form-field appearance="outline" class="time-field">
                <input matInput type="number" formControlName="green" min="0" max="255" />
              </mat-form-field>
              <span class="time-unit">sec</span>
            </div>

            <div class="light-control">
              <img src="assets/img/a.png" height="50" alt="Yellow" class="light-icon" />
              <label class="light-label">YELLOW</label>
              <mat-form-field appearance="outline" class="time-field">
                <input matInput type="number" formControlName="yellow" min="0" max="255" />
              </mat-form-field>
              <span class="time-unit">sec</span>
            </div>

            <div class="light-control">
              <img src="assets/img/r.png" height="50" alt="Red" class="light-icon" />
              <label class="light-label">RED</label>
              <mat-form-field appearance="outline" class="time-field">
                <input matInput type="number" formControlName="red" min="0" max="255" />
              </mat-form-field>
              <span class="time-unit">sec</span>
            </div>
          </div>

          <div class="blink-options">
            <div class="blink-title">Blink Options</div>
            <div class="blink-controls">
              <mat-checkbox formControlName="blinkGreen">Blink Green</mat-checkbox>
              <mat-checkbox formControlName="blinkYellow">Blink Yellow</mat-checkbox>
              <mat-checkbox formControlName="blinkRed">Blink Red</mat-checkbox>
            </div>

            <div class="form-row">
              <div class="form-group">
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Blink (ms)</mat-label>
                  <input matInput type="number" formControlName="blinkMs" placeholder="500" />
                </mat-form-field>
              </div>
            </div>
          </div>
        </div> -->

        <div class="action-buttons">
          <button mat-button matStepperPrevious>Back</button>
          <button
            mat-raised-button
            color="primary"
            (click)="onApply()"
            [disabled]="trafficForm.invalid"
          >
            Apply
          </button>
        </div>
        l
      </mat-step>
    </mat-horizontal-stepper>
  </form>
</div>
