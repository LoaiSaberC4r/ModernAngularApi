<div class="wizard-wrapper" [attr.dir]="isAr ? 'rtl' : 'ltr'">
  <div class="wizard-header" [class.rtl]="isAr">
    <div class="header-icon">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="40"
        height="40"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
      >
        <circle cx="12" cy="6" r="2" />
        <circle cx="12" cy="12" r="2" />
        <circle cx="12" cy="18" r="2" />
      </svg>
    </div>

    <div class="header-text">
      <h1 class="wizard-title">
        {{ isAr ? 'معالج إعداد إشارات المرور' : 'Traffic Signal Wizard' }}
      </h1>
      <p class="wizard-subtitle">
        {{
          isAr
            ? 'قم بضبط نظام التحكم خطوة بخطوة'
            : 'Configure your traffic control system step by step'
        }}
      </p>
    </div>
  </div>

  <form [formGroup]="trafficForm" class="wizard-form">
    <mat-horizontal-stepper
      #stepper
      labelPosition="bottom"
      class="modern-stepper"
      (selectionChange)="savePersistence()"
    >
      <!-- Step 1: Location -->
      <mat-step [stepControl]="trafficForm">
        <ng-template matStepLabel>{{ isAr ? 'الموقع' : 'Location' }}</ng-template>

        <div class="step-content">
          <div class="step-header">
            <h3>{{ isAr ? 'اختر الموقع' : 'Select Location' }}</h3>
            <p>
              {{
                isAr
                  ? 'اختر المحافظة والحي لنقطة الإشارة'
                  : 'Choose the governorate and area for this traffic signal'
              }}
            </p>
          </div>

          <div class="form-row">
            <div class="form-group">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>{{ isAr ? 'المحافظة' : 'Governorate' }}</mat-label>
                <mat-select
                  formControlName="governorate"
                  (selectionChange)="onGovernorateChangeValue($event.value)"
                >
                  <mat-option [value]="null">{{ isAr ? '-- اختر --' : '-- Select --' }}</mat-option>
                  <mat-option *ngFor="let g of governates" [value]="g.governateId">{{
                    g.name
                  }}</mat-option>
                </mat-select>
              </mat-form-field>
            </div>

            <div class="form-group">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>{{ isAr ? 'الحي' : 'Area' }}</mat-label>
                <mat-select formControlName="area">
                  <mat-option [value]="null">{{ isAr ? '-- اختر --' : '-- Select --' }}</mat-option>
                  <mat-option *ngFor="let a of areas" [value]="a.areaId">{{ a.name }}</mat-option>
                </mat-select>
              </mat-form-field>
            </div>

            <div class="form-group">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>{{ isAr ? 'إدارة المرور' : 'Traffic Department' }}</mat-label>
                <mat-select formControlName="trafficDepartment">
                  <mat-option [value]="null">{{ isAr ? '-- اختر --' : '-- Select --' }}</mat-option>
                  <mat-option *ngFor="let d of trafficDepartments" [value]="d.id">
                    {{ isAr ? d.nameAr : d.nameEn }}
                  </mat-option>
                </mat-select>
              </mat-form-field>
            </div>
          </div>
        </div>

        <div class="step-footer">
          <button
            mat-flat-button
            color="primary"
            matStepperNext
            class="btn-next"
            [disabled]="
              !trafficForm.get('governorate')?.valid ||
              !trafficForm.get('area')?.valid ||
              !trafficForm.get('trafficDepartment')?.valid
            "
          >
            {{ isAr ? 'متابعة' : 'Continue' }}
            <mat-icon>{{ isAr ? 'arrow_back' : 'arrow_forward' }}</mat-icon>
          </button>
        </div>
      </mat-step>

      <!-- Step 2: Basic Info -->
      <mat-step [stepControl]="trafficForm">
        <ng-template matStepLabel>{{ isAr ? 'المعلومات الأساسية' : 'Basic Info' }}</ng-template>

        <div class="step-content">
          <div class="step-header">
            <h3>{{ isAr ? 'معلومات أساسية' : 'Basic Information' }}</h3>
            <p>
              {{
                isAr
                  ? 'أدخل بيانات الخزانة والإحداثيات'
                  : 'Enter signal box details and coordinates'
              }}
            </p>
          </div>

          <!-- Name -->
          <div class="form-row">
            <div class="form-group">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>{{ isAr ? 'الاسم' : 'Name' }}</mat-label>
                <input
                  matInput
                  formControlName="name"
                  [placeholder]="isAr ? 'مثال: اسم الكبينة' : 'e.g. Sign Box Name'"
                />
                <mat-error *ngIf="trafficForm.get('name')?.hasError('required')">
                  {{ isAr ? 'الاسم مطلوب.' : 'Name is required.' }}
                </mat-error>
              </mat-form-field>
            </div>
          </div>

          <!-- CabinetId -->
          <div class="form-row">
            <div class="form-group">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>{{ isAr ? 'معرّف الكبينة' : 'Cabinet ID' }}</mat-label>
                <input
                  matInput
                  type="number"
                  formControlName="cabinetId"
                  min="1001"
                  max="32700"
                  step="1"
                  dir="ltr"
                  [placeholder]="isAr ? 'من 1001 إلى 32700' : 'From 1001 to 32700'"
                />
                <mat-error *ngIf="trafficForm.get('cabinetId')?.hasError('required')">
                  {{ isAr ? 'المعرّف مطلوب.' : 'ID is required.' }}
                </mat-error>
                <mat-error *ngIf="trafficForm.get('cabinetId')?.hasError('min')">
                  {{ isAr ? 'أقل قيمة 1001.' : 'Minimum is 1001.' }}
                </mat-error>
                <mat-error *ngIf="trafficForm.get('cabinetId')?.hasError('max')">
                  {{ isAr ? 'أقصى قيمة 32700.' : 'Maximum is 32700.' }}
                </mat-error>
                <mat-error *ngIf="trafficForm.get('cabinetId')?.hasError('pattern')">
                  {{ isAr ? 'يجب أن يكون رقمًا صحيحًا.' : 'Must be an integer.' }}
                </mat-error>
              </mat-form-field>
            </div>
          </div>

          <!-- IP + Lat/Lng -->
          <div class="form-row py-3">
            <!-- IPv4 -->
            <div class="form-group">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>{{ isAr ? 'عنوان IP' : 'IP Address' }}</mat-label>
                <input
                  matInput
                  formControlName="ipAddress"
                  [placeholder]="isAr ? 'مثال: 192.168.1.50' : 'e.g. 192.168.1.50'"
                  dir="ltr"
                />
                <mat-error *ngIf="trafficForm.get('ipAddress')?.hasError('required')">
                  {{ isAr ? 'عنوان IP مطلوب.' : 'IP Address is required.' }}
                </mat-error>
                <mat-error *ngIf="trafficForm.get('ipAddress')?.hasError('pattern')">
                  {{ isAr ? 'صيغة IP غير صحيحة.' : 'Invalid IP format.' }}
                </mat-error>
              </mat-form-field>
            </div>

            <!-- Lat -->
            <div class="form-group">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>{{ isAr ? 'خط العرض' : 'Latitude' }}</mat-label>
                <input
                  matInput
                  type="number"
                  formControlName="latitude"
                  step="0.0001"
                  min="-90"
                  max="90"
                  dir="ltr"
                />
                <mat-error *ngIf="trafficForm.get('latitude')?.hasError('required')">
                  {{ isAr ? 'خط العرض مطلوب.' : 'Latitude is required.' }}
                </mat-error>
              </mat-form-field>
            </div>

            <!-- Lng -->
            <div class="form-group">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>{{ isAr ? 'خط الطول' : 'Longitude' }}</mat-label>
                <input
                  matInput
                  type="number"
                  formControlName="longitude"
                  step="0.0001"
                  min="-180"
                  max="180"
                  dir="ltr"
                />
                <mat-error *ngIf="trafficForm.get('longitude')?.hasError('required')">
                  {{ isAr ? 'خط الطول مطلوب.' : 'Longitude is required.' }}
                </mat-error>
              </mat-form-field>
            </div>
          </div>

          <!-- Directions -->
          <div class="directions-section" formArrayName="directions">
            <div class="section-title">
              <h4>{{ isAr ? 'اتجاهات الحركة' : 'Traffic Directions' }}</h4>
              <span class="direction-count">{{ directions.length }}/4</span>
            </div>

            <div
              class="direction-card"
              *ngFor="let dir of directions.controls; let i = index"
              [formGroupName]="i"
            >
              <div class="direction-number">{{ i + 1 }}</div>

              <div class="direction-fields">
                <!-- Direction Name -->
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>{{ directionLabel(i) }}</mat-label>

                  <input
                    matInput
                    formControlName="name"
                    (keypress.space.capture)="forceSpaceAtCaret($event, dir)"
                    [placeholder]="isAr ? 'مثال: اتجاه السويس' : 'e.g. Direction: Suez'"
                  />

                  <mat-error *ngIf="dir.get('name')?.hasError('required')">
                    {{ isAr ? 'اسم الاتجاه مطلوب.' : 'Direction name is required.' }}
                  </mat-error>
                </mat-form-field>

                <!-- Template per direction -->
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>{{ isAr ? 'القالب' : 'Template' }}</mat-label>
                  <mat-select
                    formControlName="templateId"
                    (selectionChange)="onDirectionTemplateChange(i, $event.value)"
                  >
                    <mat-option [value]="0">{{
                      isAr ? '-- اختر القالب --' : '-- Select Template --'
                    }}</mat-option>
                    <mat-option *ngFor="let t of templates" [value]="t.id">{{ t.name }}</mat-option>
                  </mat-select>
                </mat-form-field>

                <!-- Lane / Order -->
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>{{ isAr ? 'المسار' : 'Lane' }}</mat-label>
                  <input matInput type="number" formControlName="order" min="1" />
                  <mat-error
                    *ngIf="
                      dir.get('order')?.hasError('required') || dir.get('order')?.hasError('min')
                    "
                  >
                    {{
                      isAr ? 'المسار يجب أن يكون رقمًا موجبًا.' : 'Lane must be a positive number.'
                    }}
                  </mat-error>
                </mat-form-field>

                <!-- Conflict With -->
                <mat-form-field
                  appearance="outline"
                  class="full-width"
                  *ngIf="directions.length > 1"
                >
                  <mat-label>{{
                    isAr ? 'يتقاطع مع (رقم المسار)' : 'Conflicts with (Lane #)'
                  }}</mat-label>
                  <mat-select
                    formControlName="conflictWith"
                    (selectionChange)="onConflictSelected(i, $event.value)"
                  >
                    <mat-option [value]="null">{{
                      isAr ? '-- اختر --' : '-- Select --'
                    }}</mat-option>
                    <mat-option
                      *ngFor="let other of directions.controls; let j = index"
                      [value]="other.get('order')?.value"
                      [disabled]="j === i || other.get('isConflict')?.value === true"
                    >
                      {{
                        other.value?.name || (isAr ? 'اتجاه ' + (j + 1) : 'Direction ' + (j + 1))
                      }}
                      — {{ isAr ? 'مسار' : 'Lane' }} {{ other.get('order')?.value }}
                    </mat-option>
                  </mat-select>
                  <mat-hint>
                    {{
                      isAr
                        ? 'اختر رقم مسار يتقاطع مع هذا المسار ليشارك نفس القالب'
                        : 'Pick a lane number that conflicts to share the same template'
                    }}
                  </mat-hint>
                </mat-form-field>

                <!-- Hidden fields (managed by code) -->
                <input type="hidden" formControlName="left" />
                <input type="hidden" formControlName="right" />
                <input type="hidden" formControlName="isConflict" />
              </div>

              <button
                mat-icon-button
                color="warn"
                class="btn-remove"
                (click)="removeDirection(i)"
                [disabled]="directions.length === 1"
                [attr.aria-label]="isAr ? 'حذف الاتجاه' : 'Remove direction'"
              >
                <mat-icon>delete</mat-icon>
              </button>
            </div>

            <button
              mat-stroked-button
              color="primary"
              class="btn-add-direction"
              (click)="addDirection()"
              [disabled]="directions.length >= 4"
            >
              <mat-icon>add_circle_outline</mat-icon>
              {{ isAr ? 'إضافة اتجاه' : 'Add Direction' }}
            </button>
          </div>
        </div>

        <div class="step-footer">
          <button mat-button matStepperPrevious class="btn-back">
            <mat-icon>{{ isAr ? 'arrow_forward' : 'arrow_back' }}</mat-icon>
            {{ isAr ? 'رجوع' : 'Back' }}
          </button>
          <button
            mat-flat-button
            color="primary"
            class="btn-next"
            [disabled]="isStep2Invalid() || isSavingStep2"
            (click)="onStep2Next(stepper)"
          >
            <span *ngIf="!isSavingStep2">
              {{ isAr ? 'حفظ ومتابعة' : 'Save & Continue' }}
              <mat-icon>{{ isAr ? 'arrow_back' : 'arrow_forward' }}</mat-icon>
            </span>
            <span *ngIf="isSavingStep2">
              <mat-icon><mat-spinner diameter="18" color="accent"></mat-spinner></mat-icon>
              {{ isAr ? 'جاري الحفظ...' : 'Saving...' }}
            </span>
          </button>
        </div>
      </mat-step>

      <!-- Step 3: Map & Node Binding -->
      <mat-step>
        <ng-template matStepLabel>{{ isAr ? 'ربط الموقع' : 'Map Binding' }}</ng-template>

        <div class="step-content">
          <div class="step-header">
            <h3>{{ isAr ? 'ربط الكابينة بنقطة على الخريطة' : 'Bind Cabinet to Road Node' }}</h3>
            <p>
              {{
                isAr
                  ? 'اختر أقرب نقطة طريق للكابينة'
                  : 'Select the nearest road node for the cabinet'
              }}
            </p>
          </div>

          <!-- Load Nodes Button -->
          <div class="text-center mb-3" *ngIf="nearestNodes.length === 0 && !isLoadingNodes">
            <button
              mat-raised-button
              color="primary"
              (click)="loadNearestNodesOnStep3()"
              class="px-4 py-2"
            >
              <mat-icon>map</mat-icon>
              {{ isAr ? 'تحميل الخريطة والنقاط' : 'Load Map & Nodes' }}
            </button>
          </div>

          <!-- Map Container -->
          <div
            class="map-wrapper"
            style="height: 500px; position: relative; margin-bottom: 20px"
            *ngIf="isLoadingNodes || nearestNodes.length > 0"
          >
            @if (isLoadingNodes) {
              <div
                class="loading-overlay"
                style="
                  position: absolute;
                  top: 0;
                  left: 0;
                  right: 0;
                  bottom: 0;
                  background: rgba(255, 255, 255, 0.9);
                  display: flex;
                  flex-direction: column;
                  align-items: center;
                  justify-content: center;
                  z-index: 1000;
                "
              >
                <div class="spinner-border text-primary"></div>
                <p class="mt-2">{{ isAr ? 'جاري تحميل النقاط...' : 'Loading nodes...' }}</p>
              </div>
            }

            <div
              #wizardMap
              id="wizardMap"
              style="height: 100%; width: 100%; border-radius: 8px; overflow: hidden"
            ></div>
          </div>

          <!-- Nearest Nodes List -->
          <div class="nodes-list mt-3" *ngIf="nearestNodes.length > 0">
            <h5>{{ isAr ? 'أقرب النقاط' : 'Nearest Nodes' }} ({{ nearestNodes.length }})</h5>
            <div class="table-responsive" style="max-height: 300px; overflow-y: auto">
              <table class="table table-hover table-sm">
                <thead class="table-light sticky-top">
                  <tr>
                    <th>#</th>
                    <th>{{ isAr ? 'المعرف' : 'Node ID' }}</th>
                    <th>{{ isAr ? 'المسافة' : 'Distance' }}</th>
                    <th>{{ isAr ? 'الإحداثيات' : 'Coordinates' }}</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  <tr
                    *ngFor="let node of nearestNodes; let i = index"
                    [class.table-active]="selectedNodeId === node.roadNodeId"
                    style="cursor: pointer"
                    (click)="onNodeSelected(node)"
                  >
                    <td>{{ i + 1 }}</td>
                    <td>
                      <small class="text-muted">{{ node.externalNodeId }}</small>
                    </td>
                    <td>
                      <strong class="text-primary">{{ node.distanceMeters.toFixed(0) }}m</strong>
                    </td>
                    <td>
                      <small>{{ node.latitude.toFixed(6) }}, {{ node.longitude.toFixed(6) }}</small>
                    </td>
                    <td>
                      <button
                        mat-button
                        color="primary"
                        size="small"
                        (click)="onNodeSelected(node); $event.stopPropagation()"
                        [disabled]="selectedNodeId === node.roadNodeId"
                      >
                        <mat-icon *ngIf="selectedNodeId === node.roadNodeId">check_circle</mat-icon>
                        {{
                          selectedNodeId === node.roadNodeId
                            ? isAr
                              ? 'محدد'
                              : 'Selected'
                            : isAr
                              ? 'اختر'
                              : 'Select'
                        }}
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- No Nodes Found -->
          <div
            class="alert alert-warning mt-3 d-flex align-items-center"
            *ngIf="!isLoadingNodes && nearestNodes.length === 0 && wizardMap"
          >
            <mat-icon class="me-2">warning</mat-icon>
            <span>
              {{
                isAr
                  ? 'لم يتم العثور على نقاط قريبة. حاول تغيير الإحداثيات.'
                  : 'No nearby nodes found. Try different coordinates.'
              }}
            </span>
          </div>

          <!-- Selected Node Info -->
          <div class="alert alert-success mt-3 d-flex align-items-center" *ngIf="selectedNodeId">
            <mat-icon class="me-2">location_on</mat-icon>
            <div>
              <strong>{{ isAr ? 'تم اختيار النقطة:' : 'Selected Node:' }}</strong>
              {{ getSelectedNodeId() }}
              <br />
              <small>
                {{ isAr ? 'المسافة:' : 'Distance:' }}
                {{ getSelectedNodeDistance().toFixed(0) }}m
              </small>
            </div>
          </div>
        </div>

        <div class="step-footer">
          <button mat-button matStepperPrevious class="btn-back">
            <mat-icon>{{ isAr ? 'arrow_forward' : 'arrow_back' }}</mat-icon>
            {{ isAr ? 'رجوع' : 'Back' }}
          </button>
          <button
            mat-flat-button
            color="primary"
            matStepperNext
            class="btn-next"
            [disabled]="!selectedNodeId"
          >
            {{ isAr ? 'متابعة' : 'Continue' }}
            <mat-icon>{{ isAr ? 'arrow_back' : 'arrow_forward' }}</mat-icon>
          </button>
        </div>
      </mat-step>

      <!-- Step 4: Direction Segment Binding -->
      <mat-step>
        <ng-template matStepLabel>{{ isAr ? 'ربط الاتجاهات' : 'Direction Binding' }}</ng-template>

        <div class="step-content">
          <div class="step-header">
            <h3>{{ isAr ? 'ربط الاتجاهات بمقاطع الطريق' : 'Bind Directions to Road Segments' }}</h3>
            <p>
              {{
                isAr
                  ? 'اختر كل اتجاه وحدد مقطع الطريق المناسب له من الخريطة'
                  : 'Select each direction and choose its corresponding road segment from the map'
              }}
            </p>
          </div>

          <!-- Load Segments Button -->
          <div class="text-center mb-3" *ngIf="incomingSegments.length === 0 && !isLoadingNodes">
            <button
              mat-raised-button
              color="primary"
              (click)="loadIncomingSegmentsOnStep4()"
              class="px-4 py-2"
            >
              <mat-icon>alt_route</mat-icon>
              {{ isAr ? 'تحميل المسارات' : 'Load Road Segments' }}
            </button>
          </div>

          <div
            class="row g-3"
            *ngIf="savedDirectionIds.length > 0 || incomingSegments.length > 0 || isLoadingNodes"
          >
            <!-- Left Panel: Directions List -->
            <div class="col-md-4">
              <div class="card h-100 shadow-sm border-0">
                <div class="card-header bg-light">
                  <h6 class="mb-0">{{ isAr ? 'الاتجاهات' : 'Directions' }}</h6>
                </div>
                <div class="list-group list-group-flush">
                  <button
                    type="button"
                    *ngFor="let dir of savedDirectionIds"
                    class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                    [class.active]="selectedDirectionId === dir.directionId"
                    (click)="selectedDirectionId = dir.directionId"
                  >
                    <span>
                      <mat-icon
                        class="me-2"
                        [color]="isDirectionBound(dir.directionId) ? 'primary' : 'disabled'"
                        style="vertical-align: middle; font-size: 1.2rem"
                      >
                        {{ isDirectionBound(dir.directionId) ? 'check_circle' : 'circle' }}
                      </mat-icon>
                      {{ dir.name }}
                    </span>
                    <small class="text-muted">#{{ dir.order }}</small>
                  </button>
                </div>
              </div>
            </div>

            <!-- Right Panel: Map & Segments Table -->
            <div class="col-md-8">
              <div
                class="map-wrapper"
                style="height: 400px; position: relative; margin-bottom: 20px"
              >
                <div
                  #step4MapContainer
                  id="step4Map"
                  style="height: 100%; width: 100%; border-radius: 8px; overflow: hidden"
                ></div>
                <div
                  class="loading-overlay"
                  *ngIf="isLoadingNodes"
                  style="
                    position: absolute;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(255, 255, 255, 0.7);
                    z-index: 1000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                  "
                >
                  <mat-spinner diameter="40"></mat-spinner>
                </div>
              </div>

              <!-- Available Segments (Catchy Card List) -->
              <div class="segments-section" *ngIf="selectedDirectionId">
                <div class="section-badge mb-3">
                  <span
                    class="badge rounded-pill bg-success-subtle text-success border border-success-subtle"
                  >
                    {{ isAr ? 'المسارات المتاحة' : 'Available Segments' }}
                  </span>
                </div>

                <div class="segments-grid">
                  <div
                    *ngFor="let seg of incomingSegments"
                    class="segment-card"
                    [class.active]="
                      directionalBindings.get(selectedDirectionId) === seg.roadSegmentId
                    "
                    (click)="onDirectionSegmentSelected(selectedDirectionId, seg.roadSegmentId)"
                  >
                    <div class="segment-icon">
                      <mat-icon>{{
                        directionalBindings.get(selectedDirectionId) === seg.roadSegmentId
                          ? 'check_circle'
                          : 'alt_route'
                      }}</mat-icon>
                    </div>
                    <div class="segment-info">
                      <div class="segment-name">{{ seg.name }}</div>
                      <div class="segment-meta">
                        <span class="meta-item">
                          <mat-icon>straighten</mat-icon>
                          {{ seg.lengthMeters.toFixed(0) }}m
                        </span>
                        <span class="meta-item" *ngIf="seg.speedKmh">
                          <mat-icon>speed</mat-icon>
                          {{ seg.speedKmh }} km/h
                        </span>
                      </div>
                    </div>
                    <div class="segment-status">
                      <button
                        mat-icon-button
                        *ngIf="directionalBindings.get(selectedDirectionId) !== seg.roadSegmentId"
                      >
                        <mat-icon>chevron_right</mat-icon>
                      </button>
                      <span
                        class="bound-text"
                        *ngIf="directionalBindings.get(selectedDirectionId) === seg.roadSegmentId"
                      >
                        {{ isAr ? 'مرتبط' : 'Bound' }}
                      </span>
                    </div>
                  </div>
                </div>

                <!-- Empty State -->
                <div
                  class="empty-segments"
                  *ngIf="incomingSegments.length === 0 && !isLoadingNodes"
                >
                  <mat-icon class="empty-icon">search_off</mat-icon>
                  <p>
                    {{
                      isAr
                        ? 'لا توجد مسارات متاحة لهذا الموقع'
                        : 'No available segments for this location'
                    }}
                  </p>
                </div>
              </div>

              <!-- No Direction Selected Hint -->
              <div
                class="alert alert-info"
                *ngIf="!selectedDirectionId && incomingSegments.length > 0"
              >
                {{
                  isAr
                    ? 'برجاء اختيار اتجاه من القائمة الجانبية للبدء بالربط'
                    : 'Please select a direction from the left list to start binding'
                }}
              </div>
            </div>
          </div>
        </div>

        <div class="step-footer">
          <button mat-button matStepperPrevious class="btn-back">
            <mat-icon>{{ isAr ? 'arrow_forward' : 'arrow_back' }}</mat-icon>
            {{ isAr ? 'رجوع' : 'Back' }}
          </button>
          <button
            mat-flat-button
            color="primary"
            matStepperNext
            class="btn-next"
            [disabled]="!allDirectionsBound()"
          >
            {{ isAr ? 'متابعة' : 'Continue' }}
            <mat-icon>{{ isAr ? 'arrow_back' : 'arrow_forward' }}</mat-icon>
          </button>
        </div>
      </mat-step>

      <!-- Step 4: Review & Apply -->
      <mat-step [stepControl]="trafficForm">
        <ng-template matStepLabel>{{ isAr ? 'مراجعة' : 'Review' }}</ng-template>

        <div class="step-content">
          <div class="step-header">
            <h3>{{ isAr ? 'مراجعة وتأكيد' : 'Review & Confirm' }}</h3>
            <p>
              {{
                isAr ? 'تحقق من جميع التفاصيل قبل التطبيق' : 'Verify all details before applying'
              }}
            </p>
          </div>

          <div class="summary-card">
            <mat-card-header>
              <mat-card-title></mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <section class="summary-section">
                <h4>{{ isAr ? 'المعلومات الأساسية' : 'Basic Info' }}</h4>
                <div class="summary-grid">
                  <p>
                    <strong>{{ isAr ? 'الاسم:' : 'Name:' }}</strong> {{ trafficForm.value.name }}
                  </p>
                  <p>
                    <strong>{{ isAr ? 'معرّف الكبينة:' : 'Cabinet ID:' }}</strong>
                    {{ trafficForm.value.cabinetId }}
                  </p>
                  <p>
                    <strong>{{ isAr ? 'عنوان IP:' : 'IP Address:' }}</strong>
                    {{ trafficForm.value.ipAddress }}
                  </p>
                  <p>
                    <strong>{{ isAr ? 'المحافظة:' : 'Governorate:' }}</strong>
                    {{ getGovernorateName(trafficForm.value.governorate) }}
                  </p>
                  <p>
                    <strong>{{ isAr ? 'الحي:' : 'Area:' }}</strong>
                    {{ getAreaName(trafficForm.value.area) }}
                  </p>
                  <p>
                    <strong>{{ isAr ? 'إدارة المرور:' : 'Traffic Dept:' }}</strong>
                    {{ getTrafficDepartmentName(trafficForm.value.trafficDepartment) }}
                  </p>
                </div>
              </section>

              <mat-divider class="my-2"></mat-divider>

              <section class="summary-section">
                <h4>{{ isAr ? 'ربط الموقع' : 'Location Bindings' }}</h4>
                <div class="summary-grid">
                  <p>
                    <strong>{{ isAr ? 'نقطة الطريق (Node):' : 'Road Node:' }}</strong>
                    {{ getSelectedNodeId() || (isAr ? 'لم يتم الربط' : 'Not Bound') }}
                  </p>
                  <p *ngIf="selectedNodeId">
                    <strong>{{ isAr ? 'المسافة:' : 'Distance:' }}</strong>
                    {{ getSelectedNodeDistance().toFixed(0) }}m
                  </p>
                </div>
              </section>

              <mat-divider class="my-2"></mat-divider>

              <section class="summary-section">
                <h4>{{ isAr ? 'الاتجاهات' : 'Directions' }}</h4>

                <div *ngIf="directions.controls.length; else noDir">
                  <div class="dir-card" *ngFor="let d of directions.controls; let i = index">
                    <div class="dir-header">
                      <span class="dir-order"
                        >{{ isAr ? 'المسار: ' : 'Lane: ' }}{{ d.value.order }}</span
                      >
                      <span class="dir-name">{{ getDirectionDisplayName(i) }}</span>
                      <span *ngIf="isConflict(i)" class="badge badge-conflict">
                        {{ isAr ? 'متقاطع' : 'Conflict' }}
                      </span>
                    </div>

                    <div class="dir-details">
                      <span class="dir-template">
                        <strong>{{ isAr ? 'القالب:' : 'Template:' }}</strong>
                        {{ templateName(d.value.templateId) }}
                        <span *ngIf="d.get('templateId')?.disabled" class="pill pill-locked">
                          {{ isAr ? 'مقفل بسبب التقاطع' : 'Locked by intersection' }}
                        </span>
                      </span>

                      <strong class="mx-2">{{ isAr ? 'الاتجاه: ' : 'Flow: ' }}</strong>
                      <span class="dir-pill" [class.on]="d.value.left">
                        {{ isAr ? 'يسار: ' : 'Left: ' }}
                        {{ d.value.left ? (isAr ? 'نعم' : 'Yes') : isAr ? 'لا' : 'No' }}
                      </span>
                      <span class="dir-pill" [class.on]="d.value.right">
                        {{ isAr ? 'يمين: ' : 'Right: ' }}
                        {{ d.value.right ? (isAr ? 'نعم' : 'Yes') : isAr ? 'لا' : 'No' }}
                      </span>
                    </div>

                    <div class="dir-details mt-2" *ngIf="savedDirectionIds[i]">
                      <strong>{{ isAr ? 'مقطع الطريق المرتبط:' : 'Bound Road Segment:' }}</strong>
                      <span class="text-primary ms-2">
                        {{
                          getBoundSegmentName(savedDirectionIds[i].directionId) ||
                            (isAr ? 'غير مرتبط' : 'Not Bound')
                        }}
                      </span>
                    </div>

                    <div class="dir-conflict-line" *ngIf="d.value.conflictWith">
                      <strong>{{ isAr ? 'متقاطع مع: ' : 'Conflicts with: ' }}</strong>
                      <span class="conflict-target">
                        {{ conflictTargetName(d.value.conflictWith) }}
                        ({{ isAr ? 'المسار' : 'Lane' }}: {{ d.value.conflictWith }})
                      </span>
                    </div>
                  </div>
                </div>

                <ng-template #noDir>
                  <p class="text-muted">
                    {{ isAr ? 'لا توجد اتجاهات مضافة' : 'No directions added' }}
                  </p>
                </ng-template>
              </section>
            </mat-card-content>
          </div>
        </div>

        <div class="step-footer">
          <button mat-button matStepperPrevious class="btn-back">
            <mat-icon>{{ isAr ? 'arrow_forward' : 'arrow_back' }}</mat-icon>
            {{ isAr ? 'رجوع' : 'Back' }}
          </button>
          <button
            mat-flat-button
            color="primary"
            class="btn-apply"
            (click)="onApply()"
            [disabled]="trafficForm.invalid"
          >
            <mat-icon>check_circle</mat-icon>
            {{ isAr ? 'تطبيق الإعدادات' : 'Apply Configuration' }}
          </button>
        </div>
      </mat-step>
    </mat-horizontal-stepper>
  </form>
</div>

<ng-template #loadingTpl>
  <div>{{ isAr ? 'جارِ التحميل...' : 'Loading...' }}</div>
</ng-template>
