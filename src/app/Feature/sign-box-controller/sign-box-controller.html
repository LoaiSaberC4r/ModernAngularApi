<div class="container-fluid">
  <div class="header">
    <h1 class="title">Traffic Signal Management</h1>

    <div class="search-container">
      <div class="search-box">
        <i class="fas fa-search search-icon"></i>
        <input
          type="text"
          class="search-input"
          placeholder="Search by name or ID..."
          [(ngModel)]="searchParameter.searchText"
          (keyup.enter)="onSearchEnter()"
        />
      </div>

      <!-- Active Filter -->
      <div class="filter-dropdown active-filter-dropdown">
        <button class="filter-button" (click)="showActiveFilter = !showActiveFilter">
          <i class="fas fa-power-off"></i>
          {{ activeFilter }}
          <i class="fas fa-chevron-down"></i>
        </button>
        <div class="filter-menu" [class.show]="showActiveFilter">
          <div class="filter-option" (click)="setActiveFilter('ALL')">
            <span>All</span>
            <span class="checkmark">{{ activeFilter === 'ALL' ? '✓' : '' }}</span>
          </div>
          <div class="filter-option" (click)="setActiveFilter('ACTIVE')">
            <span>Active Only</span>
            <span class="checkmark">{{ activeFilter === 'ACTIVE' ? '✓' : '' }}</span>
          </div>
          <div class="filter-option" (click)="setActiveFilter('INACTIVE')">
            <span>Inactive Only</span>
            <span class="checkmark">{{ activeFilter === 'INACTIVE' ? '✓' : '' }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Table -->
  <table class="traffic-table">
    <thead>
      <tr>
        <th>ID</th>
        <th>IpAddress</th>
        <th>Name</th>
        <th>LightPattern</th>
        <th>Apply</th>
      </tr>
    </thead>
    <tbody>
      <tr
        *ngFor="let item of filteredData"
        (mouseenter)="showPopup(item, $event)"
        (mousemove)="movePopup($event)"
        (mouseleave)="hidePopup()"
      >
        <td>{{ item.id }}</td>
        <td>{{ item.ipAddress }}</td>
        <td>{{ item.name }}</td>
        <td>
          <select
            class="lp-select"
            [(ngModel)]="item.lightPatternId"
            (ngModelChange)="onPatternChanged(item, $event)"
          >
            <option *ngFor="let p of lightPatternEntity.value" [ngValue]="p.id">
              {{ p.name }}
            </option>
          </select>
          <!-- (اختياري) لو عايز تظهر الاسم المختار أسفل الـ select -->
          <!-- <div class="lp-current">Selected: {{ item.lightPatternName || '—' }}</div> -->
        </td>
        <td>
          <button class="apply-button" (click)="applyPattern(item)">Apply</button>
        </td>
      </tr>

      <tr *ngIf="filteredData.length === 0">
        <td colspan="4" class="no-results">No traffic signals found</td>
      </tr>
    </tbody>
  </table>

  <!-- Popup -->
  <div
    class="traffic-popup"
    *ngIf="popupVisible"
    [ngStyle]="{ top: popupY + 'px', left: popupX + 'px' }"
  >
    <div class="tp-header">
      <div class="tp-title">
        <span class="tp-dot connected"></span>
        <span class="tp-name">{{ popupData?.name || '—' }}</span>
      </div>
      <span class="tp-chip">Live</span>
    </div>

    <div class="tp-grid">
      <div class="tp-col">
        <div class="tp-col__head">
          <span class="tp-col__label">L1</span>
          <span class="tp-timer">{{ popupLive?.T1 ?? 0 }}s</span>
        </div>
        <div class="tp-lamp" [ngClass]="mapCodeToClass(popupLive?.L1)">
          {{ lightEmoji(popupLive?.L1) }}
        </div>
      </div>
      <div class="tp-col">
        <div class="tp-col__head">
          <span class="tp-col__label">L2</span>
          <span class="tp-timer">{{ popupLive?.T2 ?? 0 }}s</span>
        </div>
        <div class="tp-lamp" [ngClass]="mapCodeToClass(popupLive?.L2)">
          {{ lightEmoji(popupLive?.L2) }}
        </div>
      </div>
    </div>
  </div>
</div>
