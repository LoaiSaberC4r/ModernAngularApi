<div class="container-fluid my-4" [formGroup]="templateForm">
  <div class="row g-4">
    <!-- =========================
      Left: Template Manager
    ========================= -->
    <div class="col-12 col-lg-7">
      <section class="modern-card h-100">
        <!-- Header -->
        <div class="modern-header">
          <h6 class="m-0 fw-semibold">Template Manager</h6>
        </div>

        <!-- Body -->
        <div class="modern-body">
          <!-- Template Selection -->
          <div class="d-flex align-items-center justify-content-between mb-3 flex-wrap gap-2">
            <label for="templateSelect" class="fw-semibold small text-muted mb-0"
              >Select Template</label
            >
            <select
              id="templateSelect"
              class="form-select flex-fill"
              (change)="onTemplateChange($event)"
            >
              <option value="">-- Select --</option>
              <option *ngFor="let t of templates" [value]="t.id">
                {{ t.name }}
              </option>
            </select>
          </div>

          <!-- Template Name -->
          <div class="mb-3">
            <label for="templateName" class="form-label fw-semibold small text-muted">
              Template Name <span class="text-danger">*</span>
            </label>
            <input
              id="templateName"
              type="text"
              class="form-control"
              placeholder="Descriptive name"
              formControlName="templateName"
              [class.is-invalid]="
                templateForm.get('templateName')?.invalid &&
                templateForm.get('templateName')?.touched
              "
            />
            <div
              class="invalid-feedback"
              *ngIf="
                templateForm.get('templateName')?.invalid &&
                templateForm.get('templateName')?.touched
              "
            >
              Template name is required.
            </div>
          </div>

          <!-- Schedule Rows -->
          <div class="schedule-list mb-3" formArrayName="rows">
            <div
              class="schedule-item"
              *ngFor="let row of rows.controls; let i = index"
              [formGroupName]="i"
            >
              <div class="d-flex align-items-center justify-content-between item-head">
                <div class="d-flex align-items-center gap-2">
                  <img src="assets/img/traffic-light-30625.png" height="20" alt="light" />
                  <strong>{{
                    rows.at(i).get('lightPatternName')?.value ||
                      'LightPattern #' + rows.at(i).get('lightPatternId')?.value
                  }}</strong>
                </div>
                <button
                  class="btn btn-outline-danger btn-sm"
                  type="button"
                  (click)="removeRow(i)"
                  aria-label="Remove row"
                >
                  ✖
                </button>
              </div>

              <div class="row g-2 mt-2">
                <div class="col-6">
                  <label for="startFrom{{ i }}" class="form-label small text-muted">From</label>
                  <input
                    id="startFrom{{ i }}"
                    type="time"
                    class="form-control"
                    formControlName="startFrom"
                  />
                </div>
                <div class="col-6">
                  <label for="finishBy{{ i }}" class="form-label small text-muted">To</label>
                  <input
                    id="finishBy{{ i }}"
                    type="time"
                    class="form-control"
                    formControlName="finishBy"
                  />
                </div>
              </div>
            </div>

            <!-- Empty State -->
            <div class="alert alert-info text-center py-2" *ngIf="rows.length === 0">
              No rows yet. Choose a pattern and click “Add To Template”.
            </div>
          </div>

          <!-- Add Pattern -->
          <div class="row g-2 align-items-center mb-3">
            <div class="col-auto">
              <label for="lpSel" class="col-form-label small text-muted">Select</label>
            </div>
            <div class="col">
              <select id="lpSel" class="form-select" #lpSel>
                <option value="">-- choose --</option>
                <option *ngFor="let lp of lightPatterns" [value]="lp.id">
                  {{ lp.name || 'ID ' + lp.id }}
                </option>
              </select>
            </div>
            <div class="col-auto">
              <button
                class="btn btn-outline-success"
                type="button"
                (click)="lpSel.value && addRowFromSelect(+lpSel.value)"
              >
                Add To Template
              </button>
            </div>
          </div>
        </div>

        <!-- Footer -->
        <div class="modern-footer">
          <button
            class="btn btn-outline-danger"
            type="button"
            (click)="deleteTemplate()"
            [disabled]="!templateForm.value.templateId || submitting"
          >
            Delete Template
          </button>
          <button
            class="btn btn-success"
            type="button"
            (click)="saveTemplatePattern()"
            [disabled]="submitting || templateForm.invalid || rows.length === 0"
          >
            {{ submitting ? 'Saving…' : 'Save Template' }}
          </button>
        </div>
      </section>
    </div>

    <!-- =========================
      Right: Light Pattern Editor
    ========================= -->
    <div class="col-12 col-lg-5">
      <section class="modern-card h-100" [formGroup]="patternForm">
        <div class="modern-header">
          <h6 class="m-0 fw-semibold">Light Pattern Editor</h6>
        </div>

        <div class="modern-body">
          <!-- Pattern Name -->
          <label for="lpName" class="form-label fw-semibold small text-muted">
            Name <span class="text-danger">*</span>
          </label>
          <input
            id="lpName"
            type="text"
            class="form-control"
            placeholder="Pattern name"
            formControlName="name"
            [class.is-invalid]="
              patternForm.get('name')?.invalid && patternForm.get('name')?.touched
            "
          />
          <div
            class="invalid-feedback"
            *ngIf="patternForm.get('name')?.invalid && patternForm.get('name')?.touched"
          >
            Name is required.
          </div>

          <!-- Select Pattern -->
          <label for="patternSelect" class="form-label small text-muted mt-3"
            >Select Existing Pattern</label
          >
          <select
            id="patternSelect"
            class="form-select"
            formControlName="selectedPattern"
            (change)="onPatternChange()"
          >
            <option [ngValue]="null">-- None --</option>
            <option *ngFor="let p of lightPatterns" [ngValue]="p">{{ p.name }}</option>
          </select>

          <!-- Timing Inputs -->
          <div class="timing-section mt-3">
            <div class="time-row">
              <img src="assets/img/g.png" alt="green" height="32" />
              <input
                type="number"
                class="form-control w-auto"
                formControlName="green"
                min="0"
                max="1000"
                step="1"
                aria-label="Green seconds"
              />
              <span class="fw-semibold small">sec</span>
            </div>

            <div class="time-row">
              <img src="assets/img/a.png" alt="yellow" height="32" />
              <input
                type="number"
                class="form-control w-auto"
                formControlName="yellow"
                min="0"
                max="1000"
                step="1"
                aria-label="Yellow seconds"
              />
              <span class="fw-semibold small">sec</span>
            </div>

            <div class="time-row">
              <img src="assets/img/r.png" alt="red" height="32" />
              <input
                type="number"
                class="form-control w-auto"
                formControlName="red"
                min="0"
                max="1000"
                step="1"
                aria-label="Red seconds"
              />
              <span class="fw-semibold small">sec</span>
            </div>
          </div>
        </div>

        <!-- Footer -->
        <div class="modern-footer justify-content-center">
          <button
            class="btn btn-outline-danger"
            type="button"
            (click)="deletePattern()"
            [disabled]="!patternForm.value.selectedPattern"
          >
            Delete
          </button>
          <button
            class="btn btn-success"
            type="button"
            (click)="createPattern()"
            [disabled]="patternForm.invalid || submitting"
          >
            {{ submitting ? 'Saving…' : 'Create Pattern ›' }}
          </button>
        </div>
      </section>
    </div>
  </div>
</div>
