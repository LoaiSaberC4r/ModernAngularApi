<div
  class="template-container mb-5 py-2"
  [formGroup]="templateForm"
  [attr.dir]="isAr ? 'rtl' : 'ltr'"
>
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <div class="header-icon">
        <svg
          width="32"
          height="32"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <rect x="3" y="3" width="7" height="7" rx="1" />
          <rect x="14" y="3" width="7" height="7" rx="1" />
          <rect x="3" y="14" width="7" height="7" rx="1" />
          <rect x="14" y="14" width="7" height="7" rx="1" />
        </svg>
      </div>
      <div>
        <h2 class="page-title">{{ tr('templateManager') }}</h2>
        <p class="page-subtitle">{{ tr('configurePatterns') }}</p>
      </div>
    </div>
  </div>

  <div class="row g-4">
    <!-- Template Manager -->
    <div class="col-12 col-lg-6">
      <section class="modern-card template-manager">
        <div class="card-header">
          <div class="header-title">
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"
              />
            </svg>
            <span>{{ tr('templateConfig') }}</span>
          </div>
        </div>

        <div class="card-body">
          <!-- Template Selection -->
          <div class="form-section">
            <label for="templateSelect" class="section-label">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"
                />
              </svg>
              {{ tr('selectTemplate') }}
            </label>

            <div style="display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap">
              <select
                id="templateSelect"
                class="form-control-modern"
                (change)="onTemplateChange($event)"
                style="min-width: 260px"
              >
                <option value="">{{ tr('chooseTemplate') }}</option>
                <!-- <option [value]="NEW_CODE">{{ tr('addNewTemplate') }}</option> -->
                <option *ngFor="let t of templates" [value]="t.id">{{ t.name }}</option>
              </select>

              <button type="button" class="btn-save" (click)="AddNewTemplate()">
                {{ tr('addNewTemplate') }}
              </button>
            </div>
          </div>

          <div class="form-section" *ngIf="showTemplateName">
            <label for="templateName" class="section-label">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7" />
                <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z" />
              </svg>
              {{ templateForm.value.templateId ? tr('editTemplateName') : tr('templateName') }}
              <span class="required-mark">*</span>
            </label>

            <input
              id="templateName"
              #templateNameRef
              type="text"
              class="form-control-modern"
              [placeholder]="tr('templateNamePh')"
              formControlName="templateName"
              [class.is-invalid]="
                templateForm.get('templateName')?.invalid &&
                templateForm.get('templateName')?.touched
              "
            />
            <div
              class="error-message"
              *ngIf="
                templateForm.get('templateName')?.invalid &&
                templateForm.get('templateName')?.touched
              "
            >
              {{ tr('templateNameReq') }}
            </div>
          </div>

          <!-- Schedule Rows -->
          <div class="form-section">
            <label class="section-label">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
                <line x1="16" y1="2" x2="16" y2="6" />
                <line x1="8" y1="2" x2="8" y2="6" />
                <line x1="3" y1="10" x2="21" y2="10" />
              </svg>
              {{ tr('scheduleTimeline') }}
              <span class="badge-count">{{ rows.length }}</span>
            </label>

            <div class="schedule-list" formArrayName="rows">
              <div
                class="schedule-card"
                *ngFor="let row of rows.controls; let i = index"
                [formGroupName]="i"
              >
                <div class="schedule-header">
                  <div class="pattern-info">
                    <div class="pattern-icon">
                      <img src="assets/img/traffic-light-30625.png" height="24" alt="light" />
                    </div>
                    <div class="pattern-name">
                      {{
                        rows.at(i).get('lightPatternName')?.value ||
                          tr('lightPattern') + ' #' + rows.at(i).get('lightPatternId')?.value
                      }}
                    </div>
                  </div>
                  <button
                    class="btn-icon-danger"
                    type="button"
                    (click)="removeRow(i)"
                    [attr.aria-label]="tr('removeRow')"
                  >
                    <svg
                      width="16"
                      height="16"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <path
                        d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"
                      />
                    </svg>
                  </button>
                </div>

                <div class="time-range">
                  <div class="time-input-group">
                    <label for="startFrom{{ i }}" class="time-label">{{ tr('start') }}</label>

                    <app-time-24h-input
                      formControlName="startFrom"
                      [dir]="'ltr'"
                      [label]="''"
                      [minuteStep]="1"
                    />
                  </div>

                  <div class="time-divider">{{ isAr ? '←' : '→' }}</div>

                  <div class="time-input-group">
                    <label for="finishBy{{ i }}" class="time-label">{{ tr('end') }}</label>

                    <app-time-24h-input
                      formControlName="finishBy"
                      [dir]="'ltr'"
                      [label]="''"
                      [minuteStep]="1"
                    />
                  </div>
                </div>

                <div
                  class="default-toggle"
                  style="margin-top: 0.5rem; display: flex; align-items: center; gap: 0.5rem"
                >
                  <label class="chk" style="display: flex; align-items: center; gap: 0.4rem">
                    <input
                      type="checkbox"
                      formControlName="isDefault"
                      (change)="onDefaultChange(i)"
                      [disabled]="hasDefaultSelected && !rows.at(i).get('isDefault')?.value"
                    />
                    <span>{{ tr('defaultPattern') }}</span>
                  </label>
                  <small
                    class="text-muted"
                    *ngIf="hasDefaultSelected && !rows.at(i).get('isDefault')?.value"
                  >
                    {{
                      isAr ? 'مسموح باختيار نمط افتراضي واحد فقط' : 'Only one default is allowed'
                    }}
                  </small>
                </div>
              </div>

              <!-- Empty State -->
              <div class="empty-state" *ngIf="rows.length === 0">
                <svg
                  width="48"
                  height="48"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.5"
                >
                  <circle cx="12" cy="12" r="10" />
                  <path d="M12 8v4m0 4h.01" />
                </svg>
                <p class="empty-text">{{ tr('noSchedule') }}</p>
                <p class="empty-hint">{{ tr('selectPatternHint') }}</p>
              </div>
            </div>
          </div>

          <!-- Add Pattern -->
          <div class="add-pattern-section">
            <div
              class="add-pattern-controls"
              style="display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap"
            >
              <select
                id="lpSel"
                class="form-control-modern flex-grow-1"
                #lpSel
                (change)="onAddSectionPatternChange($event)"
              >
                <option value="">{{ tr('chooseLightPattern') }}</option>
                <option *ngFor="let lp of lightPatterns" [value]="lp.id">
                  {{ lp.name || tr('pattern') + ' #' + lp.id }}
                </option>
              </select>

              <button
                class="btn-add"
                type="button"
                (click)="lpSel.value && addRowFromSelect(+lpSel.value)"
              >
                <svg
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <line x1="12" y1="5" x2="12" y2="19" />
                  <line x1="5" y1="12" x2="19" y2="12" />
                </svg>
                {{ tr('addToSchedule') }}
              </button>

              <button type="button" class="btn-save" (click)="startAddNewLightPattern()">
                {{ tr('addNewLightPattern') }}
              </button>
            </div>
          </div>
        </div>

        <!-- Footer -->
        <div class="modern-footer">
          <button
            class="btn btn-outline-danger"
            type="button"
            (click)="deleteTemplate()"
            [disabled]="!templateForm.value.templateId || submitting"
          >
            {{ tr('deleteTemplate') }}
          </button>
          <button
            class="btn btn-success"
            type="button"
            (click)="saveTemplatePattern()"
            [disabled]="submitting || templateForm.invalid || rows.length === 0"
          >
            {{ submitting ? tr('saving') : tr('saveTemplate') }}
          </button>
        </div>
      </section>
    </div>
    <!--  Light Pattern Editor -->
    <div class="col-12 col-lg-6">
      <section class="modern-card pattern-editor" [formGroup]="patternForm">
        <div class="card-header">
          <div class="header-title">
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <circle cx="12" cy="12" r="10" />
              <circle cx="12" cy="12" r="3" />
              <line x1="12" y1="1" x2="12" y2="3" />
              <line x1="12" y1="21" x2="12" y2="23" />
              <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" />
              <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" />
            </svg>
            <span>{{ tr('lightPatternEditor') }}</span>
          </div>
        </div>

        <div class="card-body">
          <div class="form-section">
            <label for="patternSelect" class="section-label">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <polyline points="9 11 12 14 22 4" />
                <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11" />
              </svg>
              {{ tr('loadExisting') }}
            </label>

            <div style="display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap">
              <select
                id="patternSelect"
                class="form-control-modern"
                formControlName="selectedPattern"
                (change)="onPatternChange()"
                style="min-width: 260px"
              >
                <option [ngValue]="undefined">
                  {{ isAr ? 'اختر نمطًا…' : 'Choose a pattern…' }}
                </option>
                <option *ngFor="let p of lightPatterns" [ngValue]="p">{{ p.name }}</option>
              </select>

              <button type="button" class="btn-save" (click)="startAddNewLightPattern()">
                {{ tr('addNewLightPattern') }}
              </button>
            </div>
            <small class="text-muted" *ngIf="!showPatternFields">
              {{ tr('selectPatternHint') }}
            </small>
          </div>

          <div class="form-section" *ngIf="showPatternFields">
            <label for="lpName" class="section-label">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M12 20h9M16.5 3.5a2.121 2.121 0 013 3L7 19l-4 1 1-4L16.5 3.5z" />
              </svg>
              {{ patternForm.value.selectedPattern ? tr('editPatternName') : tr('patternName') }}
              <span class="required-mark">*</span>
            </label>

            <input
              #patternNameRef
              id="lpName"
              type="text"
              class="form-control-modern"
              [placeholder]="tr('patternNamePh')"
              formControlName="name"
              [class.is-invalid]="
                patternForm.get('name')?.invalid && patternForm.get('name')?.touched
              "
            />
            <div
              class="error-message"
              *ngIf="patternForm.get('name')?.invalid && patternForm.get('name')?.touched"
            >
              {{ tr('patternNameReq') }}
            </div>
          </div>

          <div class="form-section">
            <label class="section-label">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <circle cx="12" cy="12" r="10" />
                <polyline points="12 6 12 12 16 14" />
              </svg>
              {{ tr('lightDurations') }}
            </label>

            <!-- Green -->
            <div class="light-row green-light">
              <div
                class="light-visual"
                [class.blink]="patternForm.value.blinkGreen && patternForm.value.blinkInterval > 0"
                [style.--blinkMs.ms]="patternForm.value.blinkInterval || 500"
              >
                <img src="assets/img/g.png" alt="green" height="40" />
                <span class="light-label">{{ tr('green') }}</span>
              </div>
              <div
                class="light-input-wrapper"
                style="flex-direction: column; align-items: flex-start"
              >
                <div style="display: flex; align-items: center; gap: 0.5rem">
                  <input
                    type="number"
                    class="light-input"
                    formControlName="green"
                    min="0"
                    max="1000"
                    step="1"
                    dir="ltr"
                    [attr.aria-label]="tr('greenSec')"
                    [class.is-invalid]="
                      patternForm.get('green')?.invalid && patternForm.get('green')?.touched
                    "
                  />
                  <span class="light-unit">{{ tr('sec') }}</span>
                </div>
                <div
                  class="error-msg-mini"
                  *ngIf="patternForm.get('green')?.hasError('serverError')"
                >
                  {{ patternForm.get('green')?.getError('serverError') }}
                </div>
              </div>
              <label class="blink-toggle">
                <input type="checkbox" formControlName="blinkGreen" />
                <span>{{ isAr ? 'وميض' : 'Blink' }}</span>
              </label>
            </div>

            <!-- Yellow -->
            <div
              class="light-row yellow-light"
              [class.merged-with-green]="patternForm.value.mergeYellowWith === 'green'"
              [class.merged-with-red]="patternForm.value.mergeYellowWith === 'red'"
            >
              <div
                class="light-visual"
                [class.blink]="patternForm.value.blinkYellow && patternForm.value.blinkInterval > 0"
                [style.--blinkMs.ms]="patternForm.value.blinkInterval || 500"
              >
                <img src="assets/img/a.png" alt="yellow" height="40" />
                <span class="light-label">{{ tr('yellow') }}</span>
              </div>
              <div
                class="light-input-wrapper"
                style="flex-direction: column; align-items: flex-start"
              >
                <div style="display: flex; align-items: center; gap: 0.5rem">
                  <input
                    type="number"
                    class="light-input"
                    formControlName="yellow"
                    min="0"
                    max="1000"
                    step="1"
                    dir="ltr"
                    [attr.aria-label]="tr('yellowSec')"
                    [class.is-invalid]="
                      patternForm.get('yellow')?.invalid && patternForm.get('yellow')?.touched
                    "
                  />
                  <span class="light-unit">{{ tr('sec') }}</span>
                </div>
                <div
                  class="error-msg-mini"
                  *ngIf="patternForm.get('yellow')?.hasError('serverError')"
                >
                  {{ patternForm.get('yellow')?.getError('serverError') }}
                </div>
              </div>
              <label class="blink-toggle">
                <input type="checkbox" formControlName="blinkYellow" />
                <span>{{ isAr ? 'وميض' : 'Blink' }}</span>
              </label>

              <!-- Merge Dropdown -->
              <div class="merge-dropdown-wrapper">
                <label class="merge-label">
                  <svg
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    class="merge-icon"
                  >
                    <circle cx="18" cy="18" r="3" />
                    <circle cx="6" cy="6" r="3" />
                    <path d="M6 21V9a9 9 0 0 0 9 9" />
                  </svg>
                  <span class="merge-text">{{ tr('mergeWith') }}</span>
                </label>
                <select
                  class="merge-select"
                  formControlName="mergeYellowWith"
                  [attr.aria-label]="tr('selectLight')"
                >
                  <option value="none">{{ tr('none') }}</option>
                  <option value="green">{{ tr('green') }}</option>
                  <option value="red">{{ tr('red') }}</option>
                </select>
              </div>
            </div>

            <!-- Red -->
            <div class="light-row red-light">
              <div
                class="light-visual"
                [class.blink]="patternForm.value.blinkRed && patternForm.value.blinkInterval > 0"
                [style.--blinkMs.ms]="patternForm.value.blinkInterval || 500"
              >
                <img src="assets/img/r.png" alt="red" height="40" />
                <span class="light-label">{{ tr('red') }}</span>
              </div>
              <div
                class="light-input-wrapper"
                style="flex-direction: column; align-items: flex-start"
              >
                <div style="display: flex; align-items: center; gap: 0.5rem">
                  <input
                    type="number"
                    class="light-input"
                    formControlName="red"
                    min="0"
                    max="1000"
                    step="1"
                    dir="ltr"
                    [attr.aria-label]="tr('redSec')"
                    [class.is-invalid]="
                      patternForm.get('red')?.invalid && patternForm.get('red')?.touched
                    "
                  />
                  <span class="light-unit">{{ tr('sec') }}</span>
                </div>
                <div class="error-msg-mini" *ngIf="patternForm.get('red')?.hasError('serverError')">
                  {{ patternForm.get('red')?.getError('serverError') }}
                </div>
              </div>
              <label class="blink-toggle">
                <input type="checkbox" formControlName="blinkRed" />
                <span>{{ isAr ? 'وميض' : 'Blink' }}</span>
              </label>
            </div>

            <!-- Blink interval (ms) -->
            <div class="form-section" style="margin-top: 0.5rem">
              <label for="blinkMs" class="section-label">
                <svg
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M12 6v6l4 2" />
                  <circle cx="12" cy="12" r="10" />
                </svg>
                {{ isAr ? 'زمن الوميض (مللي ثانية)' : 'Blink interval (ms)' }}
              </label>
              <div style="display: flex; align-items: center; gap: 0.75rem">
                <input
                  id="blinkMs"
                  type="number"
                  class="form-control-modern"
                  formControlName="blinkInterval"
                  min="50"
                  max="10000"
                  step="10"
                  dir="ltr"
                  style="max-width: 180px"
                  [placeholder]="isAr ? 'مثال: 500' : 'e.g. 500'"
                />
                <small class="text-muted">
                  {{ isAr ? 'المدى المقترح 50–10000 مللي ثانية' : 'Suggested range 50–10000 ms' }}
                </small>
              </div>
              <div
                class="error-message"
                *ngIf="
                  patternForm.get('blinkInterval')?.invalid &&
                  patternForm.get('blinkInterval')?.touched
                "
              >
                {{ isAr ? 'قيمة غير صالحة.' : 'Invalid value.' }}
              </div>
            </div>

            <!-- All Lights Zero Error -->
            <div
              class="error-message"
              style="
                margin-top: 1rem;
                padding: 0.75rem;
                background: rgba(231, 76, 60, 0.1);
                border-radius: 8px;
                border: 1px solid #e74c3c;
              "
              *ngIf="patternForm.errors?.['allLightsZero'] && patternForm.touched"
            >
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                style="display: inline-block; vertical-align: middle; margin-right: 0.5rem"
              >
                <circle cx="12" cy="12" r="10" />
                <line x1="12" y1="8" x2="12" y2="12" />
                <line x1="12" y1="16" x2="12.01" y2="16" />
              </svg>
              {{ tr('allLightsZeroError') }}
            </div>
          </div>
        </div>

        <!-- Footer -->
        <div class="card-footer">
          <button
            class="btn-delete"
            type="button"
            (click)="deletePattern()"
            [disabled]="!patternForm.value.selectedPattern"
          >
            {{ tr('delete') }}
          </button>
          <button
            class="btn-save"
            type="button"
            (click)="createPattern()"
            [disabled]="patternForm.invalid || submitting || !showPatternFields"
          >
            {{ submitting ? tr('saving') : tr('createPattern') }}
          </button>
        </div>
      </section>
    </div>
  </div>
</div>
