<div
  class="template-container mt-5 mb-5 py-5"
  [formGroup]="templateForm"
  [attr.dir]="isAr ? 'rtl' : 'ltr'"
>
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <div class="header-icon">
        <svg
          width="32"
          height="32"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <rect x="3" y="3" width="7" height="7" rx="1" />
          <rect x="14" y="3" width="7" height="7" rx="1" />
          <rect x="3" y="14" width="7" height="7" rx="1" />
          <rect x="14" y="14" width="7" height="7" rx="1" />
        </svg>
      </div>
      <div>
        <h2 class="page-title">{{ tr('templateManager') }}</h2>
        <p class="page-subtitle">{{ tr('configurePatterns') }}</p>
      </div>
    </div>
  </div>

  <div class="row g-4">
    <!-- Left: Template Manager -->
    <div class="col-12 col-lg-7">
      <section class="modern-card template-manager">
        <div class="card-header">
          <div class="header-title">
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"
              />
            </svg>
            <span>{{ tr('templateConfig') }}</span>
          </div>
        </div>

        <div class="card-body">
          <!-- Template Selection -->
          <div class="form-section">
            <label for="templateSelect" class="section-label">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"
                />
              </svg>
              {{ tr('selectTemplate') }}
            </label>
            <select
              id="templateSelect"
              class="form-control-modern"
              (change)="onTemplateChange($event)"
            >
              <option value="">{{ tr('chooseTemplate') }}</option>
              <option *ngFor="let t of templates" [value]="t.id">
                {{ t.name }}
              </option>
            </select>
          </div>

          <!-- Template Name -->
          <div class="form-section">
            <label for="templateName" class="section-label">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7" />
                <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z" />
              </svg>
              {{ tr('templateName') }} <span class="required-mark">*</span>
            </label>
            <input
              id="templateName"
              type="text"
              class="form-control-modern"
              [placeholder]="tr('templateNamePh')"
              formControlName="templateName"
              [class.is-invalid]="
                templateForm.get('templateName')?.invalid &&
                templateForm.get('templateName')?.touched
              "
            />
            <div
              class="error-message"
              *ngIf="
                templateForm.get('templateName')?.invalid &&
                templateForm.get('templateName')?.touched
              "
            >
              {{ tr('templateNameReq') }}
            </div>
          </div>

          <!-- Schedule Rows -->
          <div class="form-section">
            <label class="section-label">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
                <line x1="16" y1="2" x2="16" y2="6" />
                <line x1="8" y1="2" x2="8" y2="6" />
                <line x1="3" y1="10" x2="21" y2="10" />
              </svg>
              {{ tr('scheduleTimeline') }}
              <span class="badge-count">{{ rows.length }}</span>
            </label>

            <div class="schedule-list" formArrayName="rows">
              <div
                class="schedule-card"
                *ngFor="let row of rows.controls; let i = index"
                [formGroupName]="i"
              >
                <div class="schedule-header">
                  <div class="pattern-info">
                    <div class="pattern-icon">
                      <img src="assets/img/traffic-light-30625.png" height="24" alt="light" />
                    </div>
                    <div class="pattern-name">
                      {{
                        rows.at(i).get('lightPatternName')?.value ||
                          tr('lightPattern') + ' #' + rows.at(i).get('lightPatternId')?.value
                      }}
                    </div>
                  </div>
                  <button
                    class="btn-icon-danger"
                    type="button"
                    (click)="removeRow(i)"
                    [attr.aria-label]="tr('removeRow')"
                  >
                    <svg
                      width="16"
                      height="16"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <path
                        d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"
                      />
                    </svg>
                  </button>
                </div>

                <div class="time-range">
                  <div class="time-input-group">
                    <label for="startFrom{{ i }}" class="time-label">{{ tr('start') }}</label>
                    <input
                      id="startFrom{{ i }}"
                      type="time"
                      class="time-input"
                      formControlName="startFrom"
                      dir="ltr"
                    />
                  </div>
                  <div class="time-divider">{{ isAr ? '←' : '→' }}</div>
                  <div class="time-input-group">
                    <label for="finishBy{{ i }}" class="time-label">{{ tr('end') }}</label>
                    <input
                      id="finishBy{{ i }}"
                      type="time"
                      class="time-input"
                      formControlName="finishBy"
                      dir="ltr"
                    />
                  </div>
                </div>
              </div>

              <!-- Empty State -->
              <div class="empty-state" *ngIf="rows.length === 0">
                <svg
                  width="48"
                  height="48"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.5"
                >
                  <circle cx="12" cy="12" r="10" />
                  <path d="M12 8v4m0 4h.01" />
                </svg>
                <p class="empty-text">{{ tr('noSchedule') }}</p>
                <p class="empty-hint">{{ tr('selectPatternHint') }}</p>
              </div>
            </div>
          </div>

          <!-- Add Pattern -->
          <div class="add-pattern-section">
            <div class="add-pattern-controls">
              <select id="lpSel" class="form-control-modern flex-grow-1" #lpSel>
                <option value="">{{ tr('chooseLightPattern') }}</option>
                <option *ngFor="let lp of lightPatterns" [value]="lp.id">
                  {{ lp.name || tr('pattern') + ' #' + lp.id }}
                </option>
              </select>
              <button
                class="btn-add"
                type="button"
                (click)="lpSel.value && addRowFromSelect(+lpSel.value)"
              >
                <svg
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <line x1="12" y1="5" x2="12" y2="19" />
                  <line x1="5" y1="12" x2="19" y2="12" />
                </svg>
                {{ tr('addToSchedule') }}
              </button>
            </div>
          </div>
        </div>

        <!-- Footer -->
        <div class="modern-footer">
          <button
            class="btn btn-outline-danger"
            type="button"
            (click)="deleteTemplate()"
            [disabled]="!templateForm.value.templateId || submitting"
          >
            {{ tr('deleteTemplate') }}
          </button>
          <button
            class="btn btn-success"
            type="button"
            (click)="saveTemplatePattern()"
            [disabled]="submitting || templateForm.invalid || rows.length === 0"
          >
            {{ submitting ? tr('saving') : tr('saveTemplate') }}
          </button>
        </div>
      </section>
    </div>

    <!-- Right: Light Pattern Editor -->
    <div class="col-12 col-lg-5">
      <section class="modern-card pattern-editor" [formGroup]="patternForm">
        <div class="card-header">
          <div class="header-title">
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <circle cx="12" cy="12" r="10" />
              <circle cx="12" cy="12" r="3" />
              <line x1="12" y1="1" x2="12" y2="3" />
              <line x1="12" y1="21" x2="12" y2="23" />
              <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" />
              <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" />
            </svg>
            <span>{{ tr('lightPatternEditor') }}</span>
          </div>
        </div>

        <div class="card-body">
          <!-- Pattern Name -->
          <div class="form-section">
            <label for="lpName" class="section-label">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M12 20h9M16.5 3.5a2.121 2.121 0 013 3L7 19l-4 1 1-4L16.5 3.5z" />
              </svg>
              {{ tr('patternName') }} <span class="required-mark">*</span>
            </label>
            <input
              id="lpName"
              type="text"
              class="form-control-modern"
              [placeholder]="tr('patternNamePh')"
              formControlName="name"
              [class.is-invalid]="
                patternForm.get('name')?.invalid && patternForm.get('name')?.touched
              "
            />
            <div
              class="error-message"
              *ngIf="patternForm.get('name')?.invalid && patternForm.get('name')?.touched"
            >
              {{ tr('patternNameReq') }}
            </div>
          </div>

          <!-- Select Existing Pattern -->
          <div class="form-section">
            <label for="patternSelect" class="section-label">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <polyline points="9 11 12 14 22 4" />
                <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11" />
              </svg>
              {{ tr('loadExisting') }}
            </label>
            <select
              id="patternSelect"
              class="form-control-modern"
              formControlName="selectedPattern"
              (change)="onPatternChange()"
            >
              <option [ngValue]="null">{{ tr('createNewPattern') }}</option>
              <option *ngFor="let p of lightPatterns" [ngValue]="p">{{ p.name }}</option>
            </select>
          </div>

          <!-- Timing Configuration -->
          <div class="form-section">
            <label class="section-label">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <circle cx="12" cy="12" r="10" />
                <polyline points="12 6 12 12 16 14" />
              </svg>
              {{ tr('lightDurations') }}
            </label>

            <div class="lights-config">
              <!-- Green Light -->
              <div class="light-row green-light">
                <div class="light-visual">
                  <img src="assets/img/g.png" alt="green" height="40" />
                  <span class="light-label">{{ tr('green') }}</span>
                </div>
                <div class="light-input-wrapper">
                  <input
                    type="number"
                    class="light-input"
                    formControlName="green"
                    min="0"
                    max="1000"
                    step="1"
                    dir="ltr"
                    [attr.aria-label]="tr('greenSec')"
                  />
                  <span class="light-unit">{{ tr('sec') }}</span>
                </div>
              </div>

              <!-- Yellow Light -->
              <div class="light-row yellow-light">
                <div class="light-visual">
                  <img src="assets/img/a.png" alt="yellow" height="40" />
                  <span class="light-label">{{ tr('yellow') }}</span>
                </div>
                <div class="light-input-wrapper">
                  <input
                    type="number"
                    class="light-input"
                    formControlName="yellow"
                    min="0"
                    max="1000"
                    step="1"
                    dir="ltr"
                    [attr.aria-label]="tr('yellowSec')"
                  />
                  <span class="light-unit">{{ tr('sec') }}</span>
                </div>
              </div>

              <!-- Red Light -->
              <div class="light-row red-light">
                <div class="light-visual">
                  <img src="assets/img/r.png" alt="red" height="40" />
                  <span class="light-label">{{ tr('red') }}</span>
                </div>
                <div class="light-input-wrapper">
                  <input
                    type="number"
                    class="light-input"
                    formControlName="red"
                    min="0"
                    max="1000"
                    step="1"
                    dir="ltr"
                    [attr.aria-label]="tr('redSec')"
                  />
                  <span class="light-unit">{{ tr('sec') }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Footer -->
        <div class="card-footer">
          <button
            class="btn-delete"
            type="button"
            (click)="deletePattern()"
            [disabled]="!patternForm.value.selectedPattern"
          >
            {{ tr('delete') }}
          </button>
          <button
            class="btn-save"
            type="button"
            (click)="createPattern()"
            [disabled]="patternForm.invalid || submitting"
          >
            {{ submitting ? tr('saving') : tr('createPattern') }}
          </button>
        </div>
      </section>
    </div>
  </div>
</div>
