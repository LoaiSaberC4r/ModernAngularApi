<div class="edit-container" *ngIf="!loading; else loadingTpl">
  <h2 class="edit-title text-muted">
    Edit SignBox
    <span class="sb-name" *ngIf="form.get('name')?.value; else noName">
      — {{ form.get('name')?.value }}
    </span>
    <ng-template #noName>— (unnamed)</ng-template>

<!-- Template-driven toast stack -->
<div class="popup-stack" aria-live="polite" aria-atomic="true">
  <div
    *ngFor="let t of toasts"
    class="custom-popup"
    [ngClass]="[t.active ? 'show' : '', 'popup-' + t.type]"
    role="status"
  >
    <span class="popup-msg">{{ t.message }}</span>
    <button
      type="button"
      class="popup-close"
      (click)="dismissToast(t.id)"
      aria-label="Close notification"
    >
      ×
    </button>
  </div>
</div>
  </h2>

  <form [formGroup]="form" (ngSubmit)="apply()">
    <!-- Name -->
    <div class="form-group">
      <label for="name">Name</label>
      <input id="name" formControlName="name" class="form-control border" />
      <div *ngIf="form.controls['name'].invalid && form.controls['name'].touched" class="error">
        Name is required
      </div>
    </div>

    <!-- IP -->
    <div class="form-group">
      <label for="ip">IP Address</label>
      <input id="ip" formControlName="ipAddress" class="form-control border" />
      <div
        *ngIf="form.controls['ipAddress'].invalid && form.controls['ipAddress'].touched"
        class="error"
      >
        IP Address is required
      </div>
    </div>

    <!-- Coordinates -->
    <div class="row-2">
      <div class="form-group">
        <label for="lat">Latitude</label>
        <input
          id="lat"
          formControlName="latitude"
          class="form-control border"
          placeholder="e.g. 30.0444"
        />
      </div>
      <div class="form-group">
        <label for="lng">Longitude</label>
        <input
          id="lng"
          formControlName="longitude"
          class="form-control border"
          placeholder="e.g. 31.2357"
        />
      </div>
    </div>

    <!-- Governorate & Area -->
    <div class="row-2">
      <div class="form-group">
        <label for="gov">Governorate</label>
        <select
          id="gov"
          class="form-control border"
          formControlName="governateId"
          (change)="onGovernorateChange()"
        >
          <option [ngValue]="null" disabled>Select governorate</option>
          <option *ngFor="let g of governates" [ngValue]="g.id">{{ g.name }}</option>
        </select>
        <div
          *ngIf="form.controls['governateId'].invalid && form.controls['governateId'].touched"
          class="error"
        >
          Governorate is required
        </div>
      </div>

      <div class="form-group">
        <label for="area">Area</label>
        <select id="area" class="form-control border" formControlName="areaId">
          <option [ngValue]="null" disabled>Select area</option>
          <option *ngFor="let a of areas" [ngValue]="a.id">{{ a.name }}</option>
        </select>
        <div
          *ngIf="form.controls['areaId'].invalid && form.controls['areaId'].touched"
          class="error"
        >
          Area is required
        </div>
      </div>
    </div>

    <!-- Directions -->
    <div class="directions">
      <label>Directions</label>

      <div formArrayName="directions">
        <div
          class="dir-row"
          *ngFor="let dir of directions.controls; let i = index"
          [formGroupName]="i"
        >
          <!-- Direction name -->
          <input formControlName="name" placeholder="Direction name" class="form-control flex-1" />

          <!-- Order -->
          <input
            type="number"
            formControlName="order"
            placeholder="Order"
            min="1"
            max="4"
            step="1"
            class="form-control small"
          />
          <div
            class="error"
            *ngIf="
              (directions.at(i).get('order')?.touched || directions.at(i).get('order')?.dirty) &&
              directions.at(i).get('order')?.errors as e
            "
          >
            <span *ngIf="e['required']">Order is required.</span>
            <span *ngIf="e['min'] || e['max']">Order must be between 1 and 4.</span>
            <span *ngIf="e['duplicateOrder']">This order number is already used.</span>
          </div>

          <!-- Light Pattern -->
          <select
            class="form-control small"
            formControlName="lightPatternId"
            (change)="onPatternChange(i)"
          >
            <option [ngValue]="null" disabled>Select light pattern</option>
            <option *ngFor="let lp of lightPatterns" [ngValue]="lp.id">{{ lp.name }}</option>
          </select>

          <button type="button" class="btn btn-danger text-white" (click)="removeDirection(i)">
            Remove
          </button>
        </div>
      </div>

      <button type="button" class="btn btn-success mt-2" (click)="addDirection()">
        Add Direction
      </button>
    </div>

    <!-- Actions -->
    <div class="actions">
      <button type="submit" class="apply-button">Apply</button>
      <button type="button" (click)="cancel()" class="cancel-button">Cancel</button>
    </div>
  </form>
</div>

<ng-template #loadingTpl>
  <div>Loading...</div>
</ng-template>
