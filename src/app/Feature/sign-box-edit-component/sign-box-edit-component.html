<div class="edit-container" *ngIf="!loading; else loadingTpl" [class.rtl]="isAr">
  <h2 class="edit-title text-muted">
    {{ isAr ? 'تعديل صندوق الإشارة' : 'Edit SignBox' }}
    <span class="sb-name" *ngIf="form.get('name')?.value; else noName">
      — {{ form.get('name')?.value }}
    </span>
    <ng-template #noName>— {{ isAr ? '(بدون اسم)' : '(unnamed)' }}</ng-template>

    <!-- Toast stack -->
    <div class="popup-stack" aria-live="polite" aria-atomic="true">
      <div *ngFor="let t of toasts" class="custom-popup" [ngClass]="[t.active ? 'show' : '', 'popup-' + t.type]"
        role="status">
        <span class="popup-msg">{{ t.message }}</span>
        <button type="button" class="popup-close" (click)="dismissToast(t.id)"
          [attr.aria-label]="isAr ? 'إغلاق الإشعار' : 'Close notification'">
          ×
        </button>
      </div>
    </div>
  </h2>

  <form [formGroup]="form" (ngSubmit)="apply()">
    <!-- Name -->
    <div class="form-group">
      <label for="name">{{ isAr ? 'الاسم' : 'Name' }}</label>
      <input id="name" formControlName="name" class="form-control border"
        [placeholder]="isAr ? 'اسم وصفي' : 'Descriptive name'" [attr.dir]="isAr ? 'rtl' : 'ltr'" />
      <div *ngIf="form.controls['name'].invalid && form.controls['name'].touched" class="error">
        {{ isAr ? 'الاسم مطلوب' : 'Name is required' }}
      </div>
    </div>

    <!-- IP -->
    <div class="form-group">
      <label for="ip">{{ isAr ? 'عنوان IP' : 'IP Address' }}</label>
      <input id="ip" formControlName="ipAddress" class="form-control border" dir="ltr"
        [placeholder]="isAr ? 'مثال: 192.168.1.50' : 'e.g. 192.168.1.50'" />
      <div *ngIf="form.controls['ipAddress'].invalid && form.controls['ipAddress'].touched" class="error">
        <span *ngIf="form.controls['ipAddress'].errors?.['required']">
          {{ isAr ? 'عنوان IP مطلوب' : 'IP Address is required' }}
        </span>
        <span *ngIf="form.controls['ipAddress'].errors?.['pattern']">
          {{ isAr ? 'صيغة IP غير صحيحة' : 'Invalid IP format' }}
        </span>
      </div>
    </div>

    <!-- Coordinates -->
    <div class="row-2">
      <div class="form-group">
        <label for="lat">{{ isAr ? 'خط العرض' : 'Latitude' }}</label>
        <input id="lat" formControlName="latitude" class="form-control border" dir="ltr"
          [placeholder]="isAr ? 'مثال: 30.0444' : 'e.g. 30.0444'" />
      </div>
      <div class="form-group">
        <label for="lng">{{ isAr ? 'خط الطول' : 'Longitude' }}</label>
        <input id="lng" formControlName="longitude" class="form-control border" dir="ltr"
          [placeholder]="isAr ? 'مثال: 31.2357' : 'e.g. 31.2357'" />
      </div>
    </div>

    <!-- Governorate & Area -->
    <div class="row-2">
      <div class="form-group">
        <label for="gov">{{ isAr ? 'المحافظة' : 'Governorate' }}</label>
        <select id="gov" class="form-control-modern" formControlName="governateId" (change)="onGovernorateChange()"
          [attr.dir]="isAr ? 'rtl' : 'ltr'">
          <option [ngValue]="null" disabled>
            {{ isAr ? 'اختر المحافظة' : 'Select governorate' }}
          </option>
          <option *ngFor="let g of governates" [ngValue]="g.id">{{ g.name }}</option>
        </select>
        <div *ngIf="form.controls['governateId'].invalid && form.controls['governateId'].touched" class="error">
          {{ isAr ? 'المحافظة مطلوبة' : 'Governorate is required' }}
        </div>
      </div>

      <div class="form-group">
        <label for="area">{{ isAr ? 'الحي' : 'Area' }}</label>
        <select id="area" class="form-control-modern" formControlName="areaId" [attr.dir]="isAr ? 'rtl' : 'ltr'">
          <option [ngValue]="null" disabled>
            {{ isAr ? 'اختر الحي' : 'Select area' }}
          </option>
          <option *ngFor="let a of areas" [ngValue]="a.id">{{ a.name }}</option>
        </select>
        <div *ngIf="form.controls['areaId'].invalid && form.controls['areaId'].touched" class="error">
          {{ isAr ? 'الحي مطلوب' : 'Area is required' }}
        </div>
      </div>
    </div>

    <!-- Directions -->
    <div class="directions">
      <label>{{ isAr ? 'الاتجاهات' : 'Directions' }}</label>

      <div formArrayName="directions">
        <div class="dir-row" *ngFor="let dir of directions.controls; let i = index" [formGroupName]="i">
          <!-- Direction name -->
          <div class="form-section">
            <label class="section-label" [attr.dir]="isAr ? 'rtl' : 'ltr'">
              {{ isAr ? 'اسم الاتجاه' : 'Direction Name' }}
            </label>
            <input formControlName="name" class="form-control flex-1"
              [placeholder]="isAr ? 'اسم الاتجاه' : 'Direction name'" [attr.dir]="isAr ? 'rtl' : 'ltr'" />
          </div>

          <!-- Order -->
          <div class="form-section">
            <label class="section-label" [attr.dir]="isAr ? 'rtl' : 'ltr'">
              {{ isAr ? 'طريق' : 'Lane' }}
            </label>
            <input type="number" formControlName="order" min="1" max="4" step="1" class="form-control small"
              [placeholder]="isAr ? 'طريق' : 'Lane'" dir="ltr" />
            <div class="error" *ngIf="
            (directions.at(i).get('order')?.touched || directions.at(i).get('order')?.dirty) &&
            directions.at(i).get('order')?.errors as e
          ">
              <span *ngIf="e['required']">{{
                isAr ? 'طريق مطلوب.' : 'Lane is required.'
                }}</span>
              <span *ngIf="e['min'] || e['max']">{{
                isAr ? 'يجب أن يكون الطريقة بين 1 و 4.' : 'Lane must be between 1 and 4.'
                }}</span>
              <span *ngIf="e['duplicateOrder']">{{
                isAr ? 'رقم الطريقة مستخدم بالفعل.' : 'This lane number is already used.'
                }}</span>
            </div>
          </div>

          <!-- Template select (per direction) -->
          <div class="form-section">
            <label [for]="'templateSelect' + i" class="section-label" [attr.dir]="isAr ? 'rtl' : 'ltr'">
              {{ isAr ? 'القالب' : 'Template' }}
            </label>
            <select class="form-control-modern" [id]="'templateSelect' + i" formControlName="templateId"
              (change)="onTemplateChange(i, $event)" [attr.dir]="isAr ? 'rtl' : 'ltr'">
              <option [ngValue]="null">
                {{ isAr ? 'اختر القالب' : 'Choose template' }}
              </option>
              <option *ngFor="let t of templates" [ngValue]="t.id">
                {{ t.name }}
              </option>
            </select>
          </div>

          <!-- Remove button -->
          <div class="form-section">
            <label class="section-label">&nbsp;</label>
            <button type="button" class="btn btn-danger text-white" (click)="removeDirection(i)">
              {{ isAr ? 'حذف' : 'Remove' }}
            </button>
          </div>
        </div>
      </div>


    </div>

    <!-- Actions -->
    <div class="actions">
      <button type="button" class="add-direction-button" (click)="addDirection()">
        {{ isAr ? 'إضافة اتجاه' : 'Add Direction' }}
      </button>

      <div class="actions-end">
        <button type="submit" class="apply-button">
          {{ isAr ? 'تطبيق' : 'Apply' }}
        </button>
        <button type="button" (click)="cancel()" class="cancel-button">
          {{ isAr ? 'إلغاء' : 'Cancel' }}
        </button>
      </div>
    </div>




  </form>
</div>

<ng-template #loadingTpl>
  <div>{{ isAr ? 'جارِ التحميل...' : 'Loading...' }}</div>
</ng-template>