<div class="bg-signin" [class.rtl]="isAr">
  <div class="container-fluid p-0">
    <div class="row g-0 map-container">
      <!-- Form Section -->
      <div class="col-12 col-md-4 point-select bg-white rounded">
        <form class="traffic-form p-3" [formGroup]="trafficForm" (ngSubmit)="onApply()">
          <!-- Governorate -->
          <div class="form-group mb-3">
            <label class="form-label d-block">
              {{ isAr ? 'المحافظة' : 'Governorate' }} <span class="required">*</span>
            </label>
            <select
              class="form-control"
              formControlName="governorate"
              (change)="onGovernorateChange($event)"
              [class.is-invalid]="f['governorate'].touched && f['governorate'].invalid"
              [attr.dir]="isAr ? 'rtl' : 'ltr'"
            >
              <option value="">{{ isAr ? '-- اختر --' : '-- Select --' }}</option>
              <option *ngFor="let g of governates" [value]="g.governateId">{{ g.name }}</option>
            </select>
            <div
              class="invalid-feedback"
              *ngIf="f['governorate'].touched && f['governorate'].invalid"
            >
              {{ isAr ? 'المحافظة مطلوبة' : 'Governorate is required' }}
            </div>
          </div>

          <!-- Area -->
          <div class="form-group mb-3">
            <label class="form-label d-block">
              {{ isAr ? 'الحي' : 'Area' }} <span class="required">*</span>
            </label>
            <select
              class="form-control"
              formControlName="area"
              [class.is-invalid]="f['area'].touched && f['area'].invalid"
              [attr.dir]="isAr ? 'rtl' : 'ltr'"
            >
              <option [ngValue]="null">{{ isAr ? '-- اختر --' : '-- Select --' }}</option>
              <option *ngFor="let a of areas" [value]="a.areaId">{{ a.name }}</option>
            </select>
            <div class="invalid-feedback" *ngIf="f['area'].touched && f['area'].invalid">
              {{ isAr ? 'الحي مطلوب' : 'Area is required' }}
            </div>
          </div>

          <!-- Name -->
          <div class="form-group mb-3">
            <label class="form-label d-block">
              {{ isAr ? 'الاسم' : 'Name' }} <span class="required">*</span>
            </label>
            <input
              class="form-control"
              type="text"
              formControlName="name"
              [placeholder]="isAr ? 'اسم وصفي' : 'Descriptive name'"
              [class.is-invalid]="f['name'].touched && f['name'].invalid"
              [attr.dir]="isAr ? 'rtl' : 'ltr'"
            />
            <div class="invalid-feedback" *ngIf="f['name'].touched && f['name'].invalid">
              {{ isAr ? 'الاسم مطلوب' : 'Name is required' }}
            </div>
          </div>

          <!-- Coordinates -->
          <div class="form-group mb-3">
            <div class="row g-2">
              <div class="col-6">
                <label class="form-label d-block">
                  {{ isAr ? 'خط العرض' : 'Latitude' }} <span class="required">*</span>
                </label>
                <input
                  class="form-control"
                  type="text"
                  formControlName="latitude"
                  [placeholder]="isAr ? 'خط العرض' : 'Latitude'"
                  [class.is-invalid]="f['latitude'].touched && f['latitude'].invalid"
                  dir="ltr"
                />
              </div>
              <div class="col-6">
                <label class="form-label d-block">
                  {{ isAr ? 'خط الطول' : 'Longitude' }} <span class="required">*</span>
                </label>
                <input
                  class="form-control"
                  type="text"
                  formControlName="longitude"
                  [placeholder]="isAr ? 'خط الطول' : 'Longitude'"
                  [class.is-invalid]="f['longitude'].touched && f['longitude'].invalid"
                  dir="ltr"
                />
              </div>
            </div>
          </div>

          <!-- IP -->
          <div class="form-group mb-3">
            <label class="form-label d-block">
              {{ isAr ? 'عنوان IP' : 'IP Address' }} <span class="required">*</span>
            </label>
            <input
              class="form-control"
              type="text"
              formControlName="ipAddress"
              [placeholder]="isAr ? 'عنوان IP' : 'IP Address'"
              [class.is-invalid]="f['ipAddress'].touched && f['ipAddress'].invalid"
              dir="ltr"
            />
          </div>

          <!-- Light Pattern -->
          <div class="light-pattern-section p-3 mb-3">
            <h5 class="section-header text-center mb-3">
              {{ isAr ? 'نمط الإشارة' : 'LIGHT PATTERN' }}
            </h5>

            <!-- Template Selector -->
            <div class="form-group mb-3">
              <label class="form-label d-block">
                {{ isAr ? 'اختر القالب' : 'Select Template' }}
              </label>
              <select
                class="form-control"
                formControlName="template"
                (change)="onTemplateChange($event)"
                [attr.dir]="isAr ? 'rtl' : 'ltr'"
              >
                <option value="">{{ isAr ? '-- اختر --' : '-- Select --' }}</option>
                <option *ngFor="let g of templates" [value]="g.id">{{ g.name }}</option>
              </select>
            </div>

            <!-- Template Patterns -->
            <div class="template-patterns-section mb-3">
              <h6 class="template-patterns-header">
                {{ isAr ? 'أنماط القالب' : 'Template Patterns' }}
              </h6>
              <div *ngIf="!templatePatterns.length" class="text-muted small mb-3">
                {{
                  isAr
                    ? 'لا توجد أنماط للعرض. اختر قالبًا.'
                    : 'No patterns to show. Select a template.'
                }}
              </div>

              <div
                class="pattern-item row align-items-center py-2 border-bottom mb-2 gx-2 gy-2"
                *ngFor="let p of templatePatterns"
              >
                <!-- Icon -->
                <div class="col-auto">
                  <img src="assets/img/traffic-light-305721.png" height="30" alt="Traffic Light" />
                </div>

                <!-- Name -->
                <div class="col-auto">
                  <span class="pattern-name badge px-3 py-1">{{ p.lightPatternName }}</span>
                </div>

                <!-- From -->
                <div class="col text-center">
                  <small class="text-muted d-block">{{ isAr ? 'من:' : 'From:' }}</small>
                  <span class="time-text">{{ p.startFrom }}</span>
                </div>

                <!-- To -->
                <div class="col text-center">
                  <small class="text-muted d-block">{{ isAr ? 'إلى:' : 'To:' }}</small>
                  <span class="time-text">{{ p.finishBy }}</span>
                </div>

                <!-- Select Button -->
                <div class="col-auto text-end">
                  <button
                    class="btn btn-sm"
                    type="button"
                    (click)="onTemplatePatternChange(p.lightPatternId)"
                    [ngClass]="{
                      'btn-success': p.lightPatternId === selectedLightPatternId,
                      'btn-outline-primary': p.lightPatternId !== selectedLightPatternId
                    }"
                  >
                    {{
                      p.lightPatternId === selectedLightPatternId
                        ? isAr
                          ? 'تم الاختيار'
                          : 'Selected'
                        : isAr
                        ? 'اختر'
                        : 'Select'
                    }}
                  </button>
                </div>
              </div>
            </div>

            <!-- Timing Controls -->
            <div class="light-timing-controls">
              <div class="light-control d-flex align-items-center gap-3 mb-2">
                <img src="assets/img/g.png" height="40" alt="Green Light" />
                <input
                  class="form-control text-center flex-grow-1"
                  type="number"
                  formControlName="greenTime"
                  min="0"
                  max="1000"
                  step="1"
                  [placeholder]="isAr ? 'أخضر (ثانية)' : 'Green (sec)'"
                  dir="ltr"
                />
              </div>

              <div class="light-control d-flex align-items-center gap-3 mb-2">
                <img src="assets/img/a.png" height="40" alt="Amber Light" />
                <input
                  class="form-control text-center flex-grow-1"
                  type="number"
                  formControlName="amberTime"
                  min="0"
                  max="1000"
                  step="1"
                  [placeholder]="isAr ? 'أصفر (ثانية)' : 'Amber (sec)'"
                  dir="ltr"
                />
              </div>

              <div class="light-control d-flex align-items-center gap-3">
                <img src="assets/img/r.png" height="40" alt="Red Light" />
                <input
                  class="form-control text-center flex-grow-1"
                  type="number"
                  formControlName="redTime"
                  min="0"
                  max="1000"
                  step="1"
                  [placeholder]="isAr ? 'أحمر (ثانية)' : 'Red (sec)'"
                  dir="ltr"
                />
              </div>
            </div>
          </div>

          <!-- Actions -->
          <div class="point-settings mt-3">
            <button class="btn btn-outline-success w-100" type="submit">
              <strong>{{ isAr ? 'تطبيق' : 'Apply' }}</strong>
            </button>
          </div>
        </form>
      </div>

      <!-- Map Section -->
      <div class="col-12 col-md-8 map-view">
        <div #mapContainer id="map"></div>
      </div>
    </div>
  </div>
</div>
